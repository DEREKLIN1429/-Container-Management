<style>
    /* --- å„ªåŒ–å¾Œçš„ CSS --- */
    :root {
        --primary: #2196F3; --success: #4CAF50; --bg: #f4f7fa;
        --white: #ffffff; --text: #0f172a; --border: #cbd5e1; --accent: #1e293b;
    }
    body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 10px; color: var(--text); }
    .container { max-width: 1400px; margin: 0 auto; width: 100%; }
    
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    
    /* ç¯©é¸å¡ç‰‡æ‰‹æ©Ÿç‰ˆå„ªåŒ– */
    .filter-card { 
        background: var(--white); padding: 20px; border-radius: 20px; 
        box-shadow: 0 10px 25px rgba(0,0,0,0.1); display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;
        margin-bottom: 25px;
    }
    .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 140px; }
    .filter-group label { font-weight: 900; font-size: 0.9rem; }
    input { padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; font-weight: 700; background-color: #f8fafc; width: 100%; box-sizing: border-box; }
    
    .btn-run { background: var(--accent); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: 900; font-size: 1.2rem; height: 50px; width: 100%; }

    .stats-grid { display: flex; flex-direction: column; gap: 25px; }
    .chart-card { background: var(--white); padding: 20px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); border: 3px solid transparent; }
    
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
    .chart-title { font-weight: 900; font-size: 1.2rem; }
    
    .chart-controls { display: flex; gap: 5px; }
    .chart-select { padding: 5px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.75rem; font-weight: bold; }

    /* åœ–è¡¨é«˜åº¦æ‰‹æ©Ÿç‰ˆèª¿æ•´ */
    .chart-container { height: 350px; width: 100%; position: relative; }
    
    /* æ•¸æ“šé¢æ¿å„ªåŒ– */
    .analysis-box { margin-top: 15px; padding: 15px; background: #f8fafc; border-left: 5px solid var(--primary); border-radius: 10px; }
    .stat-grid-mini { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }

    /* æ¡Œæ©Ÿç‰ˆèª¿æ•´å›åŸæœ¬é«˜åº¦ */
    @media (min-width: 768px) {
        .chart-container { height: 500px; }
        .btn-run { width: 150px; height: 65px; }
        .chart-title { font-size: 1.6rem; }
        .filter-group { min-width: 250px; }
    }
</style>

<script>
    // --- ä¿®æ­£å¾Œçš„ i18n å­—å…¸ ---
    const i18n = {
        zh: { title: "ç‰©æµåˆ†æå ±è¡¨ v30.0", start: "é–‹å§‹æ—¥æœŸ", end: "çµæŸæ—¥æœŸ", mat: "ææ–™æœå°‹", update: "æ›´æ–°æ•¸æ“š", cT: "ğŸ“¦ è²¨æ«ƒå…¥å» æ¬¡æ•¸", wT: "âš–ï¸ å…¥å» ç¸½é‡é‡åˆ†æ", hT: "â±ï¸ ä½œæ¥­å·¥æ™‚åˆ†æ(åˆ†)", aT: "ğŸ”¥ 24H è²¨æ«ƒå…¥å» æµé‡åˆ†ä½ˆ", l1: "ç¸½å…¥å» :", l2: "ç¸½é‡é‡:", l3: "ç¸½å·¥æ™‚:", l4: "å¹³å‡å·¥æ™‚:", l5: "å¹³å‡é‡é‡:", l6: "ç”¢èƒ½æ¯”:" },
        en: { title: "Logistics Dashboard v30.0", start: "Start Date", end: "End Date", mat: "Material Search", update: "Update", cT: "ğŸ“¦ Arrivals Count", wT: "âš–ï¸ Total Tonnage", hT: "â±ï¸ Workload (Min)", aT: "ğŸ”¥ 24H Container Flow", l1: "Total Units:", l2: "Total Tons:", l3: "Total Mins:", l4: "Avg Min/Unit:", l5: "Avg Ton/Unit:", l6: "Labor Ratio:" },
        hi: { title: "à¤²à¥‰à¤œà¤¿à¤¸à¥à¤Ÿà¤¿à¤•à¥à¤¸ à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡ v30.0", start: "à¤¶à¥à¤°à¥à¤†à¤¤ à¤¤à¤¿à¤¥à¤¿", end: "à¤…à¤‚à¤¤à¤¿à¤® à¤¤à¤¿à¤¥à¤¿", mat: "à¤¸à¤¾à¤®à¤—à¥à¤°à¥€ à¤–à¥‹à¤œ", update: "à¤…à¤ªà¤¡à¥‡à¤Ÿ", cT: "ğŸ“¦ à¤•à¥à¤² à¤†à¤—à¤®à¤¨", wT: "âš–ï¸ à¤•à¥à¤² à¤µà¤œà¤¨", hT: "â±ï¸ à¤•à¤¾à¤® (à¤®à¤¿à¤¨à¤Ÿ)", aT: "ğŸ”¥ 24H à¤µà¤¿à¤¤à¤°à¤£", l1: "à¤•à¥à¤² à¤‡à¤•à¤¾à¤‡à¤¯à¤¾à¤:", l2: "à¤•à¥à¤² à¤Ÿà¤¨:", l3: "à¤•à¥à¤² à¤®à¤¿à¤¨à¤Ÿ:", l4: "à¤”à¤¸à¤¤ à¤®à¤¿à¤¨à¤Ÿ:", l5: "à¤”à¤¸à¤¤ à¤µà¤œà¤¨:", l6: "à¤•à¤¾à¤°à¥à¤¯ à¤…à¤¨à¥à¤ªà¤¾à¤¤:" }
    };

    // --- ä¿®æ­£å¾Œçš„æ•¸æ“šè™•ç†é‚è¼¯ (generateReport) ---
    function generateReport() {
        const sV = document.getElementById('date-start').value, eV = document.getElementById('date-end').value, filter = document.getElementById('mat-filter').value;
        localStorage.setItem('last_start_date', sV); localStorage.setItem('last_end_date', eV);
        const start = new Date(sV), end = new Date(eV);
        let dailyData = {}, hourlyWeight = Array(24).fill(0), daysCount = 0;

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            dailyData[d.toISOString().split('T')[0]] = { tons: 0, hours: 0, counts: 0 }; daysCount++;
        }

        rawData.forEach(r => {
            const m = r.startTime ? r.startTime.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2})/) : null;
            if (m) {
                const dObj = new Date(m[3], m[2]-1, m[1], m[4], m[5]), dKey = dObj.toISOString().split('T')[0];
                if (dailyData[dKey] && (!filter || r.formNo === filter)) {
                    const tw = (parseFloat(r.concernSection) || 0) / 1000;
                    dailyData[dKey].counts++; 
                    dailyData[dKey].tons += tw; 
                    // ä¿®æ­£ï¼šé€™è£¡ç§»é™¤ / 60ï¼Œæ”¹ä»¥ã€Œåˆ†é˜ã€è¨ˆç®—
                    dailyData[dKey].hours += (parseFloat(r.totalTime || r['Total Time'] || 0)); 
                    hourlyWeight[dObj.getHours()] += tw;
                }
            }
        });

        for(let i=1; i<=4; i++) { renderModule(i, Object.keys(dailyData).sort(), dailyData, hourlyWeight, daysCount); }
    }

    // --- ä¿®æ­£å¾Œçš„æ•¸æ“šé¡¯ç¤º (updateAnalysis) ---
    function updateAnalysis(idx, labels, dayMap) {
        const l = document.getElementById('ui-lang').value || 'zh';
        const totalC = labels.reduce((a, k) => a + dayMap[k].counts, 0);
        const totalT = labels.reduce((a, k) => a + dayMap[k].tons, 0);
        const totalH = labels.reduce((a, k) => a + dayMap[k].hours, 0);
        
        // å–®ä½æ¨™ç±¤ä¿®æ­£ç‚º Min (åˆ†é˜)
        const unitMin = l === 'zh' ? 'Min' : 'm';

        const html = `
            <div class="stat-line"><span class="stat-label">${i18n[l].l1}</span><span class="stat-num">${totalC}</span></div>
            <div class="stat-line"><span class="stat-label">${i18n[l].l4}</span><span class="stat-num">${totalC>0?(totalH/totalC).toFixed(1):0}${unitMin}</span></div>
            <div class="stat-line"><span class="stat-label">${i18n[l].l2}</span><span class="stat-num">${totalT.toFixed(1)}T</span></div>
            <div class="stat-line"><span class="stat-label">${i18n[l].l5}</span><span class="stat-num">${totalC>0?(totalT/totalC).toFixed(1):0}T</span></div>
            <div class="stat-line"><span class="stat-label">${i18n[l].l3}</span><span class="stat-num">${totalH.toFixed(0)}${unitMin}</span></div>
            <div class="stat-line"><span class="stat-label">${i18n[l].l6}</span><span class="stat-num">${totalT>0?(totalH/totalT).toFixed(2):0}</span></div>`;
        document.getElementById(`box-${idx}`).innerHTML = html;
    }
</script>
