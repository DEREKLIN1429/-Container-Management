<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Analysis Dashboard v8.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2196F3; --secondary: #673AB7; --success: #4CAF50; --bg: #f4f7f6;
            --white: #ffffff; --text: #333; --border: #e0e0e0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .filter-card { 
            background: var(--white); padding: 25px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; gap: 20px; flex-wrap: wrap; align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 8px; flex: 1; min-width: 250px; }
        .filter-group label { font-weight: 700; font-size: 0.85rem; color: #555; text-transform: uppercase; }
        
        select, input { padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 15px; outline: none; transition: border 0.3s; }
        select:focus, input:focus { border-color: var(--primary); }
        
        .btn-run { background: var(--primary); color: white; border: none; padding: 0 35px; border-radius: 10px; cursor: pointer; font-weight: 700; transition: 0.3s; height: 45px; }
        .btn-run:hover { background: #1565C0; transform: translateY(-1px); }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-top: 25px; }
        .chart-card { background: var(--white); padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 15px; }
        .chart-title { font-weight: 800; font-size: 1.1rem; color: #444; }
        .stat-value { font-size: 1.3rem; font-weight: 800; }
        
        .chart-container { height: 300px; width: 100%; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loading"><div class="loader"></div><h3 id="load-text">é›²ç«¯è³‡æ–™åŒæ­¥ä¸­...</h3></div>

    <div class="container">
        <div class="dashboard-header">
            <h1 style="margin:0; font-size: 1.8rem;">Logistics Analysis <span style="font-weight: 300; color: #888;">å ±è¡¨ä¸­å¿ƒ</span></h1>
            <div id="data-update-tag" style="font-size: 0.8rem; color: #999;"></div>
        </div>

        <div class="filter-card">
            <div class="filter-group">
                <label>1. çµ±è¨ˆæœˆä»½ (YYYY-MM)</label>
                <select id="month-select"></select>
            </div>
            <div class="filter-group">
                <label>2. åŸææ–™ / SAP CODE éæ¿¾</label>
                <input list="mat-list" id="mat-filter" placeholder="è¼¸å…¥åç¨±æˆ–ç·¨è™Ÿé€²è¡Œå½™æ•´...">
                <datalist id="mat-list"></datalist>
            </div>
            <button class="btn-run" onclick="generateReport()">ç”Ÿæˆå½™æ•´å ±è¡¨</button>
        </div>

        <div class="stats-grid">
            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">ğŸš› æ¯æ—¥å…¥å» æ¬¡æ•¸ (æ¬¡)</div>
                    <div id="sum-counts" class="stat-value" style="color:var(--success)">0 æ¬¡</div>
                </div>
                <div class="chart-container"><canvas id="countsChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">âš–ï¸ æ¯æ—¥å…¥å» é‡é‡ (å™¸)</div>
                    <div id="sum-tons" class="stat-value" style="color:var(--primary)">0.0 T</div>
                </div>
                <div class="chart-container"><canvas id="tonsChart"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-header">
                    <div class="chart-title">â±ï¸ æ¯æ—¥ä½œæ¥­å·¥æ™‚ (Hr)</div>
                    <div id="sum-hours" class="stat-value" style="color:var(--secondary)">0.0 H</div>
                </div>
                <div class="chart-container"><canvas id="hoursChart"></canvas></div>
            </div>
        </div>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxX-XRuXqIB7JJopFGYaHtiAk6kZfe19bFihOd7HCxrA-ffKQGXDoIfJwwPYFLZER8c/exec";
    let rawData = [];
    let charts = {};

    window.onload = async () => {
        toggleLoading(true, "æ­£åœ¨é€£ç·š Google Sheets...");
        try {
            const resp = await fetch(`${GAS_URL}?action=loadRecords`);
            const res = await resp.json();
            if (res.result === 'success') {
                rawData = res.data;
                initFilters();
                generateReport();
            }
        } catch (e) { alert("é€£ç·šå¤±æ•—ï¼š" + e.message); }
        toggleLoading(false);
    };

    function initFilters() {
        const months = new Set();
        const mats = new Set();
        rawData.forEach(r => {
            if (r.startTime && r.startTime.includes('/')) {
                const parts = r.startTime.split(' ')[0].split('/');
                months.add(`${parts[2]}-${parts[1]}`);
            }
            if (r.formNo) mats.add(r.formNo);
            if (r.machine) mats.add(r.machine);
        });

        const mSelect = document.getElementById('month-select');
        mSelect.innerHTML = Array.from(months).sort().reverse()
            .map(m => `<option value="${m}">${m}</option>`).join('');

        const mList = document.getElementById('mat-list');
        mList.innerHTML = Array.from(mats).map(m => `<option value="${m}">`).join('');
    }

    
    function generateReport() {
        const targetYM = document.getElementById('month-select').value;
        const filterStr = document.getElementById('mat-filter').value.toLowerCase();
        if (!targetYM) return;

        const [year, month] = targetYM.split('-');
        const daysInMonth = new Date(year, month, 0).getDate();
        
        // åˆå§‹åŒ–æ•¸æ“šé›†
        const dailyData = {};
        for (let i = 1; i <= daysInMonth; i++) {
            dailyData[String(i).padStart(2, '0')] = { tons: 0, hours: 0, counts: 0 };
        }

        let totalTons = 0, totalHours = 0, totalCounts = 0;

        rawData.forEach(r => {
            // 1. æŠ“å– C æ¬„ Arrival Time é€²è¡Œæ—¥æœŸè§£æ
            if (!r.startTime) return; 
            const dateParts = r.startTime.split(' ')[0].split('/'); // DD/MM/YYYY
            const rYM = `${dateParts[2]}-${dateParts[1]}`;
            
            // ç¯©é¸
            const isMatch = !filterStr || 
                           (r.formNo && r.formNo.toLowerCase().includes(filterStr)) || 
                           (r.machine && r.machine.toLowerCase().includes(filterStr));

            if (rYM === targetYM && isMatch) {
                const day = dateParts[0];
                
                // æ¬¡æ•¸å½™æ•´ (Arrival æ¬¡æ•¸)
                dailyData[day].counts += 1;
                totalCounts += 1;

                // 2. å™¸æ•¸è¨ˆç®— (1000 ç‚ºå–®ä½)
                const kg = parseFloat(r.concernSection) || 0;
                const tons = kg / 1000;
                dailyData[day].tons += tons;
                totalTons += tons;

                // 3. å·¥æ™‚å½™æ•´ (æŠ“å– E æ¬„ Total Time)
                // å‡è¨­ E æ¬„è³‡æ–™æ ¼å¼ç‚º "120 min" æˆ– "2.5 hr"
                const rawTime = r.totalTime || "0"; 
                dailyData[day].hours += parseTotalTimeToHours(rawTime);
                totalHours += parseTotalTimeToHours(rawTime);
            }
        });

        updateUI(totalTons, totalHours, totalCounts);
        renderCharts(dailyData);
    }

    // è§£æ Total Time æ¬„ä½ (æ”¯æ´ min/hr æ··åˆ)
    function parseTotalTimeToHours(str) {
        const val = parseFloat(str) || 0;
        if (str.includes('min')) return val / 60;
        return val; // é è¨­ç‚º hr
    }

    function updateUI(t, h, c) {
        document.getElementById('sum-tons').innerText = t.toFixed(2) + " T";
        document.getElementById('sum-hours').innerText = h.toFixed(1) + " H";
        document.getElementById('sum-counts').innerText = c + " æ¬¡";
        document.getElementById('data-update-tag').innerText = "æœ€å¾Œæ›´æ–°æ—¥æœŸ: " + new Date().toLocaleString();
    }

    function renderCharts(dayMap) {
        const labels = Object.keys(dayMap).sort().map(d => d + 'æ—¥');
        const dataCounts = labels.map((_, i) => dayMap[String(i+1).padStart(2,'0')].counts);
        const dataTons = labels.map((_, i) => dayMap[String(i+1).padStart(2,'0')].tons);
        const dataHours = labels.map((_, i) => dayMap[String(i+1).padStart(2,'0')].hours);

        // æ¬¡æ•¸åœ– (Bar)
        createChart('countsChart', 'å…¥å» æ¬¡æ•¸', dataCounts, 'rgba(76, 175, 80, 0.7)', 'bar');
        // å™¸æ•¸åœ– (Line)
        createChart('tonsChart', 'å…¥å» å™¸æ•¸ (T)', dataTons, 'rgba(33, 150, 243, 0.7)', 'line');
        // å·¥æ™‚åœ– (Bar)
        createChart('hoursChart', 'ä½œæ¥­å·¥æ™‚ (Hr)', dataHours, 'rgba(103, 58, 183, 0.7)', 'bar');
    }

    function createChart(id, label, data, color, type) {
        const ctx = document.getElementById(id).getContext('2d');
        if (charts[id]) charts[id].destroy();
        
        charts[id] = new Chart(ctx, {
            type: type,
            data: {
                labels: Array.from({length: data.length}, (_, i) => (i+1) + 'æ—¥'),
                datasets: [{
                    label: label,
                    data: data,
                    backgroundColor: color,
                    borderColor: color.replace('0.7', '1'),
                    borderWidth: 2,
                    tension: 0.3,
                    fill: type === 'line'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { 
                    y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    function toggleLoading(show, text) {
        document.getElementById('loading').style.display = show ? 'flex' : 'none';
        if(text) document.getElementById('load-text').innerText = text;
    }
</script>
</body>
</html>
