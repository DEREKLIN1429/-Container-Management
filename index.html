<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container MM INFO (æ¯æ—¥çµ±è¨ˆç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50; --bg-color: #f7f9fc; --card-bg: #ffffff;
            --danger-color: #e53935; --copy-color: #FF9800; --view-color: #212121;
            --accent-color: #673AB7; --input-border: #ddd;
        }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg-color); margin: 0; padding: 0;
            display: flex; justify-content: center; min-height: 100vh;
        }
        #status-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; width: 90%; max-width: 450px;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #app-screen { width: 100%; max-width: 500px; padding: 10px; box-sizing: border-box; }
        .header-title h2 { margin: 0; color: #333; font-size: 1.5rem; text-align: center; font-weight: 800; }
        .author-header { font-size: 0.7rem; color: #999; text-align: center; margin-bottom: 5px; }

        .card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 12px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 10px; display: block; border-left: 4px solid var(--accent-color); padding-left: 8px; }
        
        /* åœ–è¡¨èˆ‡æ§åˆ¶å€ */
        .stats-header { display: flex; gap: 8px; margin-bottom: 10px; }
        .chart-container { height: 280px; width: 100%; position: relative; }

        /* è¡¨å–® */
        .input-group { margin-bottom: 12px; display: flex; flex-direction: column; }
        .input-label { font-weight: bold; font-size: 0.85rem; margin-bottom: 4px; color: #444; }
        .text-input, textarea, select { 
            width: 100%; padding: 12px; border: 1px solid var(--input-border); 
            border-radius: 8px; font-size: 14px; box-sizing: border-box;
        }
        .time-row { display: flex; gap: 5px; }
        .btn-time { background: #00bcd4; color: white; border: none; width: 50px; border-radius: 8px; cursor: pointer; font-size: 1.2rem; }

        .footer-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; padding-bottom: 30px; }
        .btn-main { 
            height: 55px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold;
            color: white; cursor: pointer; transition: 0.2s;
        }
        .btn-save { background-color: var(--primary-color); }
        .btn-copy { background-color: var(--copy-color); }

        .preview-box {
            width: 100%; height: 180px; background: #eee; border-radius: 8px; 
            display: flex; justify-content: center; align-items: center; cursor: pointer; overflow: hidden;
            margin-top: 5px;
        }
        .preview-box img { width: 100%; height: 100%; object-fit: cover; }

        @media (min-width: 900px) {
            #app-screen { max-width: 1000px; }
            .main-layout { display: flex; gap: 20px; }
            .side-panel { flex: 1.5; }
            .main-panel { flex: 2; }
        }
    </style>
</head>
<body>

    <div id="status-modal">
        <div class="modal-box">
            <div id="status-spinner" class="spinner"></div>
            <div id="status-icon" style="display:none; font-size: 40px;"></div>
            <h3 id="status-text">Processing...</h3>
            <p id="status-subtext"></p>
            <button id="close-status" onclick="closeStatus()" class="btn-main" style="background:#2196F3; height:40px; width:100%; display:none; margin-top:10px;">OK</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="author-header">Author: DEREK LIN (v7.1 Daily Stats)</div>
        <div class="header-title"><h2>Container Management</h2></div>

        <div class="main-layout">
            <div class="side-panel">
                <div class="card" style="border-top: 5px solid var(--accent-color);">
                    <span class="section-title">Daily Statistics (æ¯æ—¥é€²å‡ºçµ±è¨ˆ)</span>
                    <div class="stats-header">
                        <select id="select-month" class="text-input" onchange="updateDailyChart()" style="flex:2">
                            </select>
                        <button onclick="reloadData()" class="text-input" style="flex:1; background:var(--accent-color); color:white; border:none; cursor:pointer;">ğŸ”„ é‡æ–°æŠ“å–</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <span class="section-title">Photo Upload</span>
                    <div class="input-label">Truck Plate Photo:</div>
                    <div class="preview-box" onclick="document.getElementById('file1').click()">
                        <span id="txt1">é»æ“Šæ‹ç…§ / é¸æ“‡ç…§ç‰‡</span>
                        <img id="img1" style="display:none">
                    </div>
                    <input type="file" id="file1" accept="image/*" capture="environment" style="display:none" onchange="handleImg(this, 1)">
                </div>
            </div>

            <div class="main-panel">
                <div class="card">
                    <span class="section-title">General Info</span>
                    <div class="input-group">
                        <label class="input-label">Employee ID:</label>
                        <input type="text" id="emp-id" class="text-input">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Material Name / SAP Code:</label>
                        <input type="text" id="mat-name" class="text-input">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Arrival Time (DD/MM/YYYY hh:mm):</label>
                        <div class="time-row">
                            <input type="text" id="time-start" class="text-input" placeholder="è‡ªå‹•ç²å–æˆ–æ‰‹å‹•è¼¸å…¥">
                            <button class="btn-time" onclick="setCurrentTime('time-start')">â±ï¸</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Plate Number:</label>
                        <input type="text" id="plate-no" class="text-input">
                    </div>
                    <div class="input-group">
                        <label class="input-label">Notes:</label>
                        <textarea id="note-text" style="height: 100px;"></textarea>
                    </div>
                </div>

                <div class="footer-btns">
                    <button class="btn-main btn-copy" onclick="copyResult()">ğŸ“‹ Copy Text</button>
                    <button class="btn-main btn-save" id="btn-save" onclick="uploadData()">ğŸ’¾ Save to Cloud</button>
                </div>
            </div>
        </div>
    </div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbxX-XRuXqIB7JJopFGYaHtiAk6kZfe19bFihOd7HCxrA-ffKQGXDoIfJwwPYFLZER8c/exec";
    let chartInstance = null;
    let allRecords = [];
    let processedImgs = { 1: "" };

    // --- 1. çµ±è¨ˆåœ–è¡¨é‚è¼¯ (æ¯æ—¥) ---

    // é‡æ–°å¾è©¦ç®—è¡¨è¼‰å…¥è³‡æ–™
    async function reloadData() {
        showStatus('loading', 'Fetching Data...', 'æ­£åœ¨åŒæ­¥é›²ç«¯æœ€æ–°è³‡æ–™');
        try {
            const resp = await fetch(`${GAS_URL}?action=loadRecords`);
            const res = await resp.json();
            if (res.result === 'success') {
                allRecords = res.data;
                initMonthSelector();
                updateDailyChart();
                closeStatus();
            }
        } catch (e) { showStatus('error', 'Error', e.message); }
    }

    // åˆå§‹åŒ–æœˆä»½ä¸‹æ‹‰é¸å–®
    function initMonthSelector() {
        const selector = document.getElementById('select-month');
        const months = new Set();
        allRecords.forEach(r => {
            if (r.startTime && r.startTime.includes('/')) {
                const parts = r.startTime.split(' ')[0].split('/'); // DD/MM/YYYY
                months.add(`${parts[2]}-${parts[1]}`); // YYYY-MM
            }
        });
        
        const sortedMonths = Array.from(months).sort().reverse();
        selector.innerHTML = sortedMonths.map(m => `<option value="${m}">${m}</option>`).join('');
    }

    
    // ç¹ªè£½æ¯æ—¥çµ±è¨ˆåœ–
    function updateDailyChart() {
        const targetYM = document.getElementById('select-month').value;
        if (!targetYM) return;

        // çµ±è¨ˆè©²æœˆæ¯ä¸€å¤©çš„æ¬¡æ•¸
        let dayStats = {};
        const [year, month] = targetYM.split('-');
        const daysInMonth = new Date(year, month, 0).getDate();

        // é å¡«è©²æœˆæ‰€æœ‰æ—¥æœŸç‚º 0
        for (let i = 1; i <= daysInMonth; i++) {
            dayStats[String(i).padStart(2, '0')] = 0;
        }

        allRecords.forEach(r => {
            if (r.startTime && r.startTime.includes('/')) {
                const parts = r.startTime.split(' ')[0].split('/'); // DD/MM/YYYY
                if (`${parts[2]}-${parts[1]}` === targetYM) {
                    dayStats[parts[0]] = (dayStats[parts[0]] || 0) + 1;
                }
            }
        });

        const labels = Object.keys(dayStats).sort();
        const dataValues = labels.map(day => dayStats[day]);

        const ctx = document.getElementById('dailyChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
            type: 'line', // ä½¿ç”¨æŠ˜ç·šåœ–è§€å¯Ÿè¶¨å‹¢ï¼Œä¹Ÿå¯æ”¹ç‚º 'bar'
            data: {
                labels: labels.map(d => d + 'æ—¥'),
                datasets: [{
                    label: targetYM + ' æ¯æ—¥é€²å‡ºæ¬¡æ•¸',
                    data: dataValues,
                    borderColor: 'rgb(103, 58, 183)',
                    backgroundColor: 'rgba(103, 58, 183, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    // --- 2. è¡¨å–®æ ¸å¿ƒåŠŸèƒ½ ---

    function setCurrentTime(id) {
        const now = new Date();
        const str = `${String(now.getDate()).padStart(2,'0')}/${String(now.getMonth()+1).padStart(2,'0')}/${now.getFullYear()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        document.getElementById(id).value = str;
    }

    function handleImg(input, slot) {
        if (!input.files[0]) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(w > 800) { h *= 800/w; w = 800; }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                processedImgs[slot] = canvas.toDataURL('image/jpeg', 0.8);
                const el = document.getElementById(`img${slot}`);
                el.src = processedImgs[slot]; el.style.display = 'block';
                document.getElementById(`txt${slot}`).style.display = 'none';
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    async function uploadData() {
        const d = {
            employeeId: document.getElementById('emp-id').value,
            formNo: document.getElementById('mat-name').value,
            startTimeFull: document.getElementById('time-start').value,
            plateNum: document.getElementById('plate-no').value,
            selfActions: document.getElementById('note-text').value,
            image1: processedImgs[1]
        };
        if(!d.formNo || !d.startTimeFull) return alert("è«‹å¡«å¯«ææ–™åç¨±èˆ‡åˆ°é”æ™‚é–“");

        showStatus('loading', 'Saving...', 'æ­£åœ¨ä¸Šå‚³è‡³ Google é›²ç«¯');
        try {
            const r = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(d) });
            const res = await r.json();
            if(res.result === 'success') {
                showStatus('success', 'Saved!', 'å„²å­˜æˆåŠŸ');
                setTimeout(reloadData, 1000); // å­˜å®Œå¾Œè‡ªå‹•åˆ·æ–°çµ±è¨ˆè³‡æ–™
            }
        } catch (e) { showStatus('error', 'Failed', e.message); }
    }

    // --- 3. UI è¼”åŠ© ---
    function showStatus(t, h, s) {
        document.getElementById('status-modal').style.display = 'flex';
        document.getElementById('status-text').innerText = h;
        document.getElementById('status-subtext').innerText = s;
        document.getElementById('status-spinner').style.display = t === 'loading' ? 'block' : 'none';
        document.getElementById('status-icon').style.display = t !== 'loading' ? 'block' : 'none';
        document.getElementById('close-status').style.display = t !== 'loading' ? 'block' : 'none';
        document.getElementById('status-icon').innerText = t === 'success' ? 'âœ…' : 'âŒ';
    }
    function closeStatus() { document.getElementById('status-modal').style.display = 'none'; }
    function copyResult() {
        const t = `ã€è²¨æ«ƒè¨˜éŒ„ã€‘\nå“¡å·¥:${document.getElementById('emp-id').value}\nææ–™:${document.getElementById('mat-name').value}\næ™‚é–“:${document.getElementById('time-start').value}\nè»Šç‰Œ:${document.getElementById('plate-no').value}`;
        navigator.clipboard.writeText(t).then(() => alert("Copied!"));
    }

    window.onload = reloadData;
</script>
</body>
</html>
